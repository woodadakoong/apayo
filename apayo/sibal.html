<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>아파용</title>
</head>
<body>
<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh;">
  <div style="width: 550px; height: 450px; margin-bottom: 10px; position: relative;">
    <div id="map" style="width: 100%; height: 100%;"></div>
    <span id="currentAddress" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; color: #333;"></span>
  </div>
  <div style="width: 550px; height: 250px; background-color: #f2f2f2; display: flex; justify-content: flex-end; align-items: flex-end; padding: 0 20px;">
    <span id="currentAddressMobile" style="font-size: 14px; color: #333;"></span>
  </div> 
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e639683ac02e3543cc5a094643bd765e&libraries=services"></script>
<script>
var map;
var overlay;
var ps = new kakao.maps.services.Places();
var keyword = '용인시 기흥구 병원'; // 키워드 입력

if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        var currentPosition = new kakao.maps.LatLng(lat, lon);

        map = new kakao.maps.Map(document.getElementById('map'), { center: currentPosition, level: 10 });

        // 현위치 마커 추가
        var currentMarker = new kakao.maps.Marker({
            map: map,
            position: currentPosition,
            image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                new kakao.maps.Size(24, 35),
                {offset: new kakao.maps.Point(12, 35)}
            )
        });

        // 현위치 커스텀 오버레이
        var currentContent = '<div class="custom-overlay">' + '현위치' + '</div>';
        var currentOverlay = new kakao.maps.CustomOverlay({
            content: currentContent,
            map: map,
            position: currentPosition,
            yAnchor: 2.5 // 약간 위쪽에 위치
        });
        currentOverlay.setMap(map);

        getAddressFromCoords(currentPosition); // 현위치 주소 가져오기
        searchPlaces(keyword); // 설정한 키워드로 검색
    });
}

function getAddressFromCoords(coords) {
    var geocoder = new kakao.maps.services.Geocoder();
    geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var address = result[0].address.address_name;
            document.getElementById('currentAddress').innerText = address;
            document.getElementById('currentAddressMobile').innerText = address;
        }
    });
}

function searchPlaces(keyword) {
    ps.keywordSearch(keyword, function(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {

            var bounds = new kakao.maps.LatLngBounds();

            for (var i = 0; i < data.length; i++) {
                displayMarker(data[i]);    
                bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
            }       

            map.setBounds(bounds);
        } 
    }); 
}

function displayMarker(place) {

    var marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(place.y, place.x) 
    });

    kakao.maps.event.addListener(marker, 'click', function() {
        if (overlay) {
            overlay.setMap(null);
        }
        
        //마커 내에 표시될 내용
        var content = '<div class="custom-overlay">' + 
                      '<div>' + place.place_name + '</div>' +
                      '<button onclick="window.location.href=\'https://place.map.kakao.com/' + place.id + '\';">임시 아이콘</button>' +
                      '</div>';
        
        overlay = new kakao.maps.CustomOverlay({
            content: content,
            map: map,
            position: marker.getPosition(), //커스텀 오버레이가 표시될 위치
            yAnchor: 1.7 // 마커의 약간 위쪽에 말풍선 띄우기 위한 값 조정
        });
        
        overlay.setMap(map); //오버레이를 지도에 표시
    });

    marker.setMap(map); //해당마커를 지도에 표시
}
</script>
<style>
    .custom-overlay {
        position: relative;
        display: inline-block;
        padding: 5px 10px;
        background-color: #fff;
        color: #333;
        font-size: 12px;
        text-align: center;
        border-radius: 10px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
    }

    .custom-overlay button {
        margin-top: 5px;
        background-color: #50627F;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>
</body>
</html>
